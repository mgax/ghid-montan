app.weather = (options) ->
  map = options.map
  button = options.button


  button.append('rect')
      .attr('class', 'buttonmask')
      .attr('width', '50')
      .attr('height', '50')
      .attr('x', '0')
      .attr('y', '0')
  button.append('path')
     # .attr('style', "fill:#144866;fill-opacity:1;image-rendering:auto")
      .attr('class', 'meteoblue-logo')
      .attr('d', "M 0,25.000039 0,3.9490035e-5 l 25,0 25,0 L 50,25.000039 l 0,25 -25,0 -25,0 0,-25 z m 5.989583,14.6019 c 0,-1.7912 0.4752553,-2.5444 1.3201696,-2.0922 0.4171303,0.2232 0.5027474,0.5558 0.5027474,1.9526 0,1.5099 0.053711,1.6835 0.520833,1.6835 0.467125,0 0.520834,-0.1736 0.520834,-1.6835 0,-1.3968 0.08562,-1.7294 0.50275,-1.9526 0.844913,-0.4522 1.320166,0.301 1.320166,2.0922 0,1.3703 0.05857,1.5439 0.520834,1.5439 0.465687,0 0.520427,-0.1723 0.516995,-1.6276 -0.0049,-2.0997 -0.402717,-2.9047 -1.487462,-3.0104 -0.4556117,-0.044 -1.0610619,0.044 -1.3454448,0.1961 -0.3426617,0.1833 -0.5714947,0.1886 -0.6784423,0.016 -0.2950681,-0.4775 -2.176326,-0.2988 -2.7348129,0.2597 -0.421625,0.4216 -0.520833,0.868 -0.520833,2.3437 0,1.6493 0.049604,1.8229 0.520833,1.8229 0.4622657,0 0.520833,-0.1736 0.520833,-1.5439 z m 10.015722,1.1931 c 0.644841,-0.4716 0.09015,-0.8261 -1.128214,-0.7211 -0.807234,0.07 -1.319768,-0.2446 -1.331435,-0.8161 -0.0021,-0.1074 0.640542,-0.1953 1.428302,-0.1953 1.392329,0 1.432292,-0.02 1.432292,-0.7233 0,-1.1865 -0.66356,-1.8809 -1.79732,-1.8809 -1.382893,0 -1.978722,0.7209 -1.978722,2.3941 0,1.0497 0.117526,1.393 0.614789,1.7956 0.715008,0.579 2.070766,0.6512 2.760308,0.147 z m -2.203222,-3.0346 c 0.315589,-0.5897 0.789646,-0.6687 1.25,-0.2083 0.524992,0.525 0.354714,0.7292 -0.60812,0.7292 -0.839924,0 -0.896187,-0.046 -0.64188,-0.5209 z m 5.46875,2.9866 c 0,-0.2193 -0.175781,-0.4662 -0.390625,-0.5487 -0.591934,-0.2271 -0.550721,-2.8897 0.04651,-3.0047 0.409231,-0.079 0.409231,-0.1121 0,-0.5213 -0.240424,-0.2405 -0.437136,-0.7385 -0.437136,-1.1068 0,-0.4961 -0.135028,-0.6697 -0.520833,-0.6697 -0.405091,0 -0.520833,0.1736 -0.520833,0.7813 0,0.4297 -0.117188,0.7812 -0.260417,0.7812 -0.143229,0 -0.260417,0.1758 -0.260417,0.3907 0,0.2148 0.117188,0.3906 0.260417,0.3906 0.146055,0 0.260417,0.7205 0.260417,1.6406 0,0.9288 0.135583,1.7762 0.3125,1.9531 0.454309,0.4543 1.510416,0.394 1.510416,-0.086 z m 3.791372,0.026 c 0.706459,-0.5214 0.186582,-1.0423 -0.702772,-0.7042 -0.737295,0.2803 -1.5261,-0.044 -1.5261,-0.6283 0,-0.2842 0.354566,-0.3777 1.432292,-0.3777 1.332391,0 1.432292,-0.043 1.432292,-0.6159 0,-0.3388 -0.24288,-0.9247 -0.539734,-1.3021 -0.676298,-0.8598 -2.07025,-0.9408 -2.845683,-0.1653 -0.746711,0.7467 -0.721221,2.7479 0.0454,3.5639 0.652596,0.6947 1.927565,0.8029 2.704309,0.2296 z m -2.228872,-2.8542 c 0,-0.3388 0.527962,-0.6789 1.053805,-0.6789 0.126474,0 0.355388,0.2344 0.508695,0.5208 0.25431,0.4752 0.198045,0.5209 -0.641878,0.5209 -0.613293,0 -0.920622,-0.1211 -0.920622,-0.3628 z m 6.770834,2.7065 c 0.675966,-0.676 0.73208,-2.9808 0.08985,-3.6904 -0.610385,-0.6745 -2.210029,-0.6341 -2.848963,0.072 -0.760792,0.8407 -0.690865,2.986 0.118697,3.6415 0.797053,0.6454 1.982326,0.6351 2.64042,-0.023 z m -2.03125,-0.8333 c -0.336904,-0.3369 -0.409125,-1.216 -0.15443,-1.8798 0.243323,-0.6341 1.369583,-0.5129 1.68593,0.1814 0.576476,1.2653 -0.628438,2.6014 -1.5315,1.6984 z m 6.725237,0.8804 c 0.478341,-0.3873 0.588987,-0.7484 0.606791,-1.9799 0.02544,-1.7611 -0.45826,-2.3292 -1.850258,-2.173 -0.82301,0.092 -0.846354,0.068 -0.846354,-0.8944 0,-0.8158 -0.09139,-0.9894 -0.520833,-0.9894 -0.489104,0 -0.520833,0.1736 -0.520833,2.8498 0,2.6497 0.04064,2.8783 0.578778,3.2552 0.772289,0.541 1.835446,0.5125 2.552709,-0.068 z m -1.986133,-0.9338 c -0.07721,-0.2012 -0.102831,-0.7578 -0.05693,-1.2369 0.06931,-0.7236 0.200735,-0.8848 0.775617,-0.9513 0.583694,-0.067 0.719042,0.042 0.863691,0.7009 0.09434,0.4295 0.04242,1.0222 -0.115388,1.3171 -0.326849,0.6107 -1.256563,0.7186 -1.466987,0.1702 z m 5.365062,1.0087 c 0,-0.2193 -0.175781,-0.4662 -0.390625,-0.5487 -0.312549,-0.1199 -0.390625,-0.6908 -0.390625,-2.8564 0,-2.5329 -0.03341,-2.7065 -0.520833,-2.7065 -0.490107,0 -0.520833,0.1736 -0.520833,2.9427 0,1.9416 0.106317,3.0491 0.3125,3.2552 0.454307,0.4543 1.510416,0.394 1.510416,-0.086 z m 3.857146,-0.1321 c 0.48087,-0.448 0.569938,-0.8143 0.569938,-2.3438 0,-1.625 -0.05271,-1.8128 -0.508935,-1.8128 -0.447099,0 -0.518292,0.2136 -0.585937,1.7578 -0.07135,1.6287 -0.12266,1.7643 -0.698595,1.8457 -0.835788,0.1182 -1.062395,-0.329 -1.06713,-2.1061 -0.0035,-1.3224 -0.06484,-1.4974 -0.52482,-1.4974 -0.470953,0 -0.520833,0.1736 -0.520833,1.8128 0,1.5295 0.08907,1.8958 0.569937,2.3438 0.321302,0.2993 0.924719,0.5309 1.383188,0.5309 0.458468,0 1.061885,-0.2316 1.383187,-0.5309 z m 4.770539,0.2524 c 0.834089,-0.4464 0.154831,-1.0214 -0.987583,-0.836 -0.637398,0.1034 -0.992398,0.037 -1.15176,-0.2143 -0.414555,-0.6548 -0.25673,-0.7545 1.19395,-0.7545 1.392325,0 1.432292,-0.02 1.432292,-0.7233 0,-1.1865 -0.66356,-1.8809 -1.797323,-1.8809 -1.097688,0 -1.704539,0.4972 -1.986661,1.6276 -0.532337,2.1331 1.424322,3.7836 3.297085,2.7814 z m -2.117268,-3.1069 c 0.296281,-0.5536 0.49224,-0.6154 1.150575,-0.3627 0.791412,0.3036 0.457555,0.8836 -0.508695,0.8836 -0.839925,0 -0.896188,-0.046 -0.64188,-0.5209 z m -1.011922,-6.4278 c 0.968818,-0.5449 1.643919,-1.1763 2.183073,-2.0418 0.758929,-1.2182 0.783089,-1.358 0.873214,-5.0531 0.115057,-4.7174 -0.12157,-5.7433 -1.667678,-7.2301 -1.200288,-1.1542 -2.440713,-1.6429 -4.152729,-1.6358 -1.06508,0 -3.049349,0.7511 -3.368658,1.2678 -0.51443,0.8323 -0.6678,-0.029 -0.6678,-3.749 l 0,-4.0363995 -1.692708,0 -1.692709,0 -0.0651,5.9243995 c -0.146669,13.347 -0.08159,13.981 1.608789,15.6713 1.372662,1.3727 2.80704,1.8506 5.256894,1.7517 1.635104,-0.066 2.228854,-0.2185 3.385416,-0.869 z m -5.574732,-2.9513 c -0.926291,-0.7286 -1.296179,-2.0551 -1.277529,-4.5816 0.02185,-2.9578 0.635657,-4.3708 2.087686,-4.8059 2.838932,-0.8505 4.487968,0.8881 4.461619,4.7041 -0.02544,3.6845 -1.003109,5.2084 -3.341612,5.2084 -0.871799,0 -1.469494,-0.1626 -1.930164,-0.525 z m -27.267513,-1.697 c 0,-5.9557 0.177063,-6.8272 1.5290551,-7.5264 2.0039199,-1.0362 4.2291619,-0.065 4.7357469,2.0661 0.136162,0.5729 0.232029,3.2096 0.21304,5.8593 l -0.03453,4.8177 1.573135,0.077 1.573139,0.077 0.09056,-5.4155 c 0.0971,-5.8064 0.255485,-6.5593 1.574232,-7.483 1.204467,-0.8436 3.706566,-0.2992 4.428011,0.9635 0.22951,0.4017 0.373771,2.326 0.463448,6.1822 l 0.130208,5.5989 1.644211,0.078 1.644214,0.078 -0.08171,-6.4582 c -0.07533,-5.9535 -0.124234,-6.5396 -0.625744,-7.4998 -1.517953,-2.9065 -5.568195,-3.6841 -8.787229,-1.6871 l -1.258341,0.7806 -0.742683,-0.5288 c -1.244932,-0.8865 -2.893822,-1.3401 -4.90269,-1.3487 -2.5538719,-0.011 -4.4694244,0.9137 -5.705135,2.7541 l -0.846354,1.2606 0,6.3508 0,6.3508 1.692708,0 1.692708,0 0,-5.347 z")


  render = ->
    [lon, lat] = map.proj.inverse(
      map.projection.invert(
        [map.width / 2, map.height / 2])
    ).map(d3.format('.04f'))

    linkBase = "https://www.meteoblue.com/en/weather/forecast/week/"
    link = linkBase + "#{lat}N#{lon}E"
    button.attr('xlink:href', link)


  map.dispatch.on 'zoomend.note', ->
    render()

  map.dispatch.on 'redraw.note', ->
    render()
